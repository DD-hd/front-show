<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <style>
    .maze-box {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .maze-table {
      left: 50%;
      transform: translateX(-50%);
      margin: auto;
      position: absolute;
      top: 0;
      bottom: 0;
      /* width: 60%; */
      border: 2px solid rgb(200, 200, 200);
      /* background-color: aquamarine; */
    }
    .maze-table td {
      border: 1px solid rgb(200, 200, 200);
      width: 16px;
      height: 16px;
    }

    .maze-table td.block {
      background-color: red;
    }

    .maze-table td.target {
      background-color: green;
    }

    .maze-table td.wall {
      background-color: black;
    }

    .maze-table td.path {
      background-color: darkkhaki;
    }
  </style>
  <body>
    <div class="maze-box">
      <table id="table" class="maze-table"></table>
    </div>
    <script>
      function makeMaze(size = 10) {
        var data = [];
        var domFrag = new DocumentFragment();
        for (var i = 0; i < size; i++) {
          var line1 = [];
          var tr = document.createElement("tr");
          var domFrag1 = new DocumentFragment();
          for (var j = 0; j < size; j++) {
            var td = document.createElement("td");
            var val;
            if (i === 1 && j === 1) {
              val = 0;
            } else if (i === 0 || i === size - 1 || j === 0 || j === size - 1) {
              val = -1;
            } else {
              val = Math.random() > 0.7 ? 1 : 0;
            }

            switch (val) {
              case 1:
                td.className = "block";
                break;
              case -1:
                td.className = "wall";
                break;
            }

            line1.push({ val: val, dom: td });
            domFrag1.appendChild(td);
          }
          tr.appendChild(domFrag1);
          domFrag.appendChild(tr);
          data.push(line1);
        }
        return { dom: domFrag, data };
      }

      function makeTarget(arr = []) {
        var pos = [];
        for (var i = 0; i < arr.length; i++) {
          for (var j = 0; j < arr[i].length; j++) {
            if (arr[i][j].val === 0) {
              pos.push({ x: j, y: i, val: arr[i][j] });
            }
          }
        }
        var index = Math.floor(Math.random() * pos.length);
        return pos[index];
      }

      function pointPath(path, end, arr) {
        setTimeout(function() {
          if (path.length > 0) {
            var nowP = path[path.length - 1];
            var find = 0;
            if (nowP.x === end.x && nowP.y === end.y) {
              alert("找到路了");
              return;
            }
            for (let i = nowP.di; i <= 4; i++) {
              var x, y;
              switch (i) {
                case 1:
                  x = nowP.x + 1;
                  y = nowP.y;
                  break;
                case 2:
                  x = nowP.x;
                  y = nowP.y + 1;
                  break;
                case 3:
                  x = nowP.x - 1;
                  y = nowP.y;
                  break;
                case 4:
                  x = nowP.x;
                  y = nowP.y - 1;
                  break;
              }
              if (arr[y][x].val === 0) {
                find = 1;
                nowP.di = i;
                break;
              }
            }
            if (find === 1) {
              var newPonit = { x: -1, y: -1, val: -1, di: 1 };
              newPonit.x = x;
              newPonit.y = y;
              newPonit.val = arr[y][x].val;
              newPonit.className = arr[y][x].dom.className;
              newPonit.di = 1;
              path.push(newPonit);
              find = 0;
              arr[y][x].val = -2;
              arr[y][x].dom.className = "target";
            } else {
              const prevPoint = path.pop();
              arr[nowP.y][nowP.x].dom.className = "";
            }
            setTimeout(pointPath.bind(this, path, end, arr), 300);
          } else {
            alert("当前迷宫没有解");
          }
        }, 300);
      }

      function findPath(start, end, arr) {
        var path = [];
        var point = { x: -1, y: -1, val: -1, di: 1 };
        point.x = start.x;
        point.y = start.y;
        point.val = start.val;
        point.di = 1;
        path.push(point);
        pointPath(path, end, arr);
      }

      function printPath(path, data, i = 0) {
        setTimeout(function() {
          if (path.length === 0 || !path[i]) {
            return;
          }
          var pos = path[i];
          var node = data[pos.y][pos.x];
          node.dom.className = "path";
          printPath(path, data, i + 1);
        }, 300);
      }

      function checkPath(path) {
        for (var i = 1; i < path.length; i++) {
          if (
            Math.abs(path[i].y - path[i - 1].y) !== 1 &&
            Math.abs(path[i].x - path[i - 1].x) !== 1
          ) {
            return { isOk: false, node: path[i] };
          }
        }
        return { isOk: true };
      }

      function start() {
        var table = document.querySelector("#table");
        table.innerHTML = "";
        var ret = makeMaze(10);
        var target = makeTarget(ret.data);
        ret.data[target.y][target.x].dom.className = "target";
        table.appendChild(ret.dom);
        var path = findPath(
          { x: 1, y: 1, val: 0 },
          { x: target.x, y: target.y, val: target.val },
          ret.data
        );
      }

      window.addEventListener("DOMContentLoaded", () => {
        start();
      });
    </script>
  </body>
</html>
